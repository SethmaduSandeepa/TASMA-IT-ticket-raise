{% extends "base.html" %}
{% block content %}
<meta http-equiv="refresh" content="7200">
<h2>Admin Dashboard â€” All Tickets</h2>
<div class="mb-3">
  <input type="text" id="searchBox" class="form-control" placeholder="Search by title, user, or status..." onkeyup="filterTickets()">
</div>
<div class="accordion" id="ticketAccordion">
{% for t in tickets|sort(attribute='created_at', reverse=True) %}
  <div class="accordion-item mb-2">
    <h2 class="accordion-header" id="heading{{ loop.index }}">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="false" aria-controls="collapse{{ loop.index }}">
        <span class="fw-bold">{{ t.title }}</span>
        <span class="ms-2 badge bg-{{ 'success' if t.status == 'Closed' else ('warning' if t.status == 'In Progress' else 'secondary') }}">{{ t.status }}</span>
        <span class="ms-2 text-muted">by {{ t.user }}</span>
        {% if t.pc_name %}
          <span class="ms-2 text-info">({{ t.pc_name }})</span>
        {% endif %}
        <span class="ms-2 text-muted created-time" data-utc="{{ t.created_at.isoformat() }}">Loading...</span>
        {% if t.updated_at %}
          <span class="ms-2 text-warning updated-time" data-utc="{{ t.updated_at.isoformat() }}">(Loading...)</span>
        {% endif %}
      </button>
    </h2>
    <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#ticketAccordion">
      <div class="accordion-body">
        <p><strong>Description:</strong> {{ t.description }}</p>
        {% if t.pc_name %}
          <p><strong>PC Name:</strong> {{ t.pc_name }}</p>
        {% endif %}
        {% if t.updated_at %}
          <p><strong>Last Updated:</strong> <span class="updated-time" data-utc="{{ t.updated_at.isoformat() }}">Loading...</span></p>
        {% endif %}
        <form method="POST" action="{{ url_for('update_ticket', ticket_id=t._id) }}" class="row g-2 align-items-center">
          <div class="col-auto">
            <label for="status{{ loop.index }}" class="form-label mb-0">Status:</label>
          </div>
          <div class="col-auto">
            <select id="status{{ loop.index }}" name="status" class="form-select d-inline w-auto">
              <option value="Open" {% if t.status == 'Open' %}selected{% endif %}>Open</option>
              <option value="In Progress" {% if t.status == 'In Progress' %}selected{% endif %}>In Progress</option>
              <option value="Closed" {% if t.status == 'Closed' %}selected{% endif %}>Closed</option>
            </select>
          </div>
          <div class="col-auto">
            <button type="submit" class="btn btn-primary btn-sm">Update</button>
          </div>
        </form>
        <form method="POST" action="{{ url_for('admin_delete_ticket', ticket_id=t._id) }}" class="mt-2" onsubmit="return confirm('Are you sure you want to delete this ticket?');">
          <button type="submit" class="btn btn-danger btn-sm"><i class="bi bi-trash"></i> Delete</button>
        </form>
      </div>
    </div>
  </div>
{% else %}
  <p>No tickets found.</p>
{% endfor %}
</div>
<script>
function filterTickets() {
  var input = document.getElementById('searchBox');
  var filter = input.value.toLowerCase();
  var acc = document.getElementById('ticketAccordion');
  var items = acc.getElementsByClassName('accordion-item');
  for (var i = 0; i < items.length; i++) {
    var header = items[i].getElementsByClassName('accordion-button')[0];
    var txtValue = header.textContent || header.innerText;
    if (txtValue.toLowerCase().indexOf(filter) > -1) {
      items[i].style.display = '';
    } else {
      items[i].style.display = 'none';
    }
  }
}

// Auto-refresh the ticket list every 10 seconds for real-time updates
setInterval(function() {
  location.reload();
}, 10000);

// Use Luxon to display times in Sri Lankan time (Asia/Colombo)
window.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.created-time').forEach(function(el) {
    const dt = luxon.DateTime.fromISO(el.getAttribute('data-utc'), { zone: 'utc' }).setZone('Asia/Colombo');
    el.textContent = dt.toFormat('yyyy-MM-dd HH:mm:ss') + ' (SL)';
  });
  document.querySelectorAll('.updated-time').forEach(function(el) {
    const dt = luxon.DateTime.fromISO(el.getAttribute('data-utc'), { zone: 'utc' }).setZone('Asia/Colombo');
    el.textContent = '(Updated: ' + dt.toFormat('yyyy-MM-dd HH:mm:ss') + ' (SL))';
  });
});
</script>
{% endblock %}